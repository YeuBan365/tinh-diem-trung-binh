<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T√≠nh ƒëi·ªÉm trung b√¨nh HUTECH</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #eef4fb;
      color: #333;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    .navbar {
      background-color: #004AAD;
      color: white;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 1000;
    }
    .navbar h1 { margin: 0; font-size: 20px; }
    .container {
      max-width: 950px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .card {
      background-color: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }
    .unlock-area {
      background-color: #fffbe6;
      border: 1px solid #ffe58f;
    }
    h2, h3 { 
      margin-top: 0; 
      color: #004AAD; 
      border-bottom: 2px solid #eef4fb; 
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    label { font-weight: bold; display: block; margin: 12px 0 6px; }
    input, select {
      box-sizing: border-box;
      padding: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus {
        border-color: #004AAD;
        box-shadow: 0 0 0 2px rgba(0, 74, 173, 0.2);
        outline: none;
    }
    #searchBox {
        margin-bottom: 20px;
    }
    button {
      background: #004AAD;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      margin-top: 10px;
      margin-right: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:hover { background: #00337d; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    
    button.btn-xoa-hang {
        background-color: #dc3545; padding: 5px 10px; font-size: 12px;
        margin: 0;
    }
    button.btn-xoa-hang:hover { background-color: #c82333; }
    button#btn-xoa { background-color: #dc3545; }
    button#btn-xoa:hover { background-color: #c82333; }
    button#btn-save-github { background-color: #28a745; }
    button#btn-save-github:hover { background-color: #218838; }
    button#btn-thoat { background-color: #6c757d; }
    button#btn-thoat:hover { background-color: #5a6268; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: left;
    }
    th {
        background-color: #004AAD;
        color: white;
        font-weight: bold;
    }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #f1f1f1; }
    td[contenteditable="true"] {
        background-color: #ffffff;
        cursor: text;
    }
    td[contenteditable="true"]:focus {
        background-color: #e6f7ff;
        outline: 2px solid #004AAD;
    }
    #result-container {
        margin-top: 20px;
        padding: 15px;
        background: #eef4fb;
        border-radius: 8px;
        border: 1px solid #004AAD;
    }
    .result-item {
        font-size: 18px;
        font-weight: bold;
        color: #004AAD;
        margin: 8px 0;
    }
  </style>
</head>
<body>

  <div class="navbar">
    <h1>üéì H·ªá th·ªëng T√≠nh ƒêi·ªÉm Trung B√¨nh HUTECH</h1>
  </div>

  <div class="container">
    <div id="unlock-section" class="card unlock-area">
      <h2>M·ªü kh√≥a D·ªØ li·ªáu Admin</h2>
      <p>D·ªØ li·ªáu c·ªßa Admin ƒë∆∞·ª£c m√£ h√≥a. Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ t·∫£i v√† gi·∫£i m√£.</p>
      <label for="matKhau">M·∫≠t kh·∫©u c·ªßa Admin:</label>
      <input type="password" id="matKhau" placeholder="Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a..." onkeydown="if(event.key==='Enter') taiVaGiaiMaDuLieu()">
      <button onclick="taiVaGiaiMaDuLieu()">üîë M·ªü kh√≥a v√† T·∫£i d·ªØ li·ªáu</button>
      <a href="https://yeuban365.github.io/tinh-diem-trung-binh/encrypt.html" target="_blank" style="text-decoration: none;">
          <button type="button" style="background-color: #17a2b8;">‚öôÔ∏è M·ªü C√¥ng c·ª• M√£ h√≥a</button>
      </a>
      <button type="button" id="btn-download-json" style="background-color: #007bff;">üì• T·∫£i d·ªØ li·ªáu .json</button>
      <button type="button" id="btn-thoat">üö™ Tho√°t</button>
      <p id="unlock-feedback"></p>
    </div>

    <div class="card">
      <h2>Nh·∫≠p H·ªçc ph·∫ßn c·ªßa b·∫°n</h2>
      <form id="form-them-mon">
          <label for="ma-mon-hoc">M√£ m√¥n h·ªçc:</label>
          <input type="text" id="ma-mon-hoc" required>
          <label for="ten-mon-hoc">T√™n m√¥n h·ªçc:</label>
          <input type="text" id="ten-mon-hoc" required>
          <label for="so-tin-chi">S·ªë t√≠n ch·ªâ (t·ª´ 1 ƒë·∫øn 4):</label>
          <input type="number" id="so-tin-chi" min="1" max="4" required>
          <label for="diem-he-10">ƒêi·ªÉm h·ªá s·ªë 10:</label>
          <input type="number" id="diem-he-10" step="0.1" min="0" max="10" required>
          
          <button type="submit" id="btn-them-mon-hoc">‚ûï Th√™m m√¥n</button>
          <button type="button" id="btn-tinh-diem-trung-binh">üìä T√≠nh ƒëi·ªÉm</button>
          <button type="button" id="btn-xoa">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
          <button type="button" id="btn-luu">üíæ L∆∞u file .doc</button>
          <button type="button" id="btn-save-github">üíæ L∆∞u & C·∫≠p nh·∫≠t l√™n Trang ch·ªß[Admin]</button>
      </form>
      <p id="thong-bao" style="color: red; font-weight: bold;"></p>
      
       <div id="upload-section" style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px;">
        <h3>Ho·∫∑c t·∫£i l√™n t·ª´ file Excel (.xlsx)</h3>
        <p><em>File Excel c·ªßa b·∫°n c·∫ßn c√≥ c√°c c·ªôt v·ªõi ti√™u ƒë·ªÅ ch√≠nh x√°c sau: <strong>MaMonHoc, TenMonHoc, SoTinChi, DiemHe10</strong></em></p>
        <input type="file" id="file-upload" accept=".xlsx, .xls" style="border: none; padding-left: 0;">
        <p id="upload-feedback"></p>

        <!-- === PH·∫¶N M√É M·ªöI ƒê∆Ø·ª¢C TH√äM V√ÄO === -->
        <h3 style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px;">Ho·∫∑c t·∫£i l√™n t·ª´ file JSON (.json)</h3>
        <p><em>File JSON ph·∫£i ch·ª©a m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ c√°c key: <strong>maMonHoc, tenMonHoc, soTinChi, diemHe10</strong>. B·∫°n c√≥ th·ªÉ d√πng n√∫t "T·∫£i d·ªØ li·ªáu .json" ·ªü tr√™n ƒë·ªÉ c√≥ file m·∫´u.</em></p>
        <input type="file" id="json-upload" accept=".json" style="border: none; padding-left: 0;">
        <p id="json-upload-feedback"></p>
        <!-- === K·∫æT TH√öC PH·∫¶N M√É M·ªöI === -->
      </div>
    </div>

    <div class="card">
      <h2>B·∫£ng ƒëi·ªÉm Chi ti·∫øt</h2>
      <p><em>M·∫πo: B·∫°n c√≥ th·ªÉ nh·∫•p chu·ªôt tr·ª±c ti·∫øp v√†o c√°c √¥ c√≥ n·ªÅn tr·∫Øng trong b·∫£ng ƒë·ªÉ s·ª≠a ƒë·ªïi.</em></p>
      <input id="searchBox" placeholder="üîç T√¨m ki·∫øm m√£ ho·∫∑c t√™n m√¥n...">
      <table>
        <thead>
          <tr>
            <th>M√£ m√¥n h·ªçc</th>
            <th>T√™n m√¥n h·ªçc</th>
            <th>S·ªë TC</th>
            <th>ƒêi·ªÉm 10</th>
            <th>ƒêi·ªÉm 4</th>
            <th>X·∫øp lo·∫°i</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="body-bang-diem"></tbody>
      </table>
      <div id="result-container">
          <p class="result-item" id="tong-tin-chi"></p>
          <p class="result-item" id="diem-trung-binh-tich-luy"></p>
      </div>
    </div>
  </div>

<script>
let bangDiem = [];
const GITHUB_USER = 'YeuBan365';
const GITHUB_REPO = 'tinh-diem-trung-binh';
const GITHUB_BRANCH = 'main';

document.addEventListener('DOMContentLoaded', () => {
    capNhatBang();
    tinhDiemTongKet();
});

function taiVaGiaiMaDuLieu() {
    const mk = document.getElementById("matKhau").value;
    const feedback = document.getElementById("unlock-feedback");
    if (!mk) {
        feedback.style.color = 'red';
        feedback.textContent = "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!";
        return;
    }
    if (bangDiem.length > 0 && !confirm("Thao t√°c n√†y s·∫Ω ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i tr√™n b·∫£ng. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) {
        return;
    }
    feedback.textContent = "ƒêang t·∫£i v√† gi·∫£i m√£ d·ªØ li·ªáu...";
    feedback.style.color = '#004AAD';
    const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data.enc?timestamp=${new Date().getTime()}`; // Ch·ªëng cache
    fetch(url)
        .then(res => {
            if (!res.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i file d·ªØ li·ªáu! Status: ${res.status}`);
            return res.text();
        })
        .then(encryptedData => {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, mk);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                if (!originalText) throw new Error("Sai m·∫≠t kh·∫©u ho·∫∑c d·ªØ li·ªáu b·ªã l·ªói.");
                bangDiem = JSON.parse(originalText);
                capNhatBang();
                tinhDiemTongKet();
                feedback.textContent = "M·ªü kh√≥a v√† t·∫£i d·ªØ li·ªáu th√†nh c√¥ng!";
                feedback.style.color = '#28a745';
                document.getElementById("matKhau").value = "";
                setTimeout(() => feedback.textContent = "", 4000);
            } catch (err) {
                console.error("L·ªói gi·∫£i m√£:", err);
                feedback.style.color = 'red';
                feedback.textContent = "M·ªü kh√≥a th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i m·∫≠t kh·∫©u.";
                bangDiem = [];
                capNhatBang();
                tinhDiemTongKet();
            }
        })
        .catch(err => {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
            feedback.style.color = 'red';
            feedback.textContent = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† ƒë∆∞·ªùng d·∫´n GitHub.";
        });
}

function downloadJsonData() {
    if (bangDiem.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i v·ªÅ. Vui l√≤ng th√™m m√¥n h·ªçc ho·∫∑c m·ªü kh√≥a d·ªØ li·ªáu tr∆∞·ªõc.");
        return;
    }
    const jsonData = JSON.stringify(bangDiem, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'HUTECH_BangDiem_Data.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}

const tinhDiemHe4 = d => (d >= 8.5) ? 4.0 : (d >= 7.8) ? 3.5 : (d >= 7.0) ? 3.0 : (d >= 6.3) ? 2.5 : (d >= 5.5) ? 2.0 : (d >= 4.8) ? 1.5 : (d >= 4.0) ? 1.0 : 0.0;
const xepLoai = d => (d >= 8.5) ? "A (Gi·ªèi)" : (d >= 7.8) ? "B+ (Kh√°)" : (d >= 7.0) ? "B (Kh√°)" : (d >= 6.3) ? "C+ (TB)" : (d >= 5.5) ? "C (TB)" : (d >= 4.8) ? "D+ (Y·∫øu)" : (d >= 4.0) ? "D (Y·∫øu)" : "F (R·ªõt)";

function capNhatBang() {
  const tuKhoa = document.getElementById("searchBox").value.toLowerCase().trim();
  const tbody = document.getElementById("body-bang-diem");
  tbody.innerHTML = "";
  const duLieuLoc = bangDiem.filter(mon =>
      (mon.maMonHoc || '').toLowerCase().includes(tuKhoa) ||
      (mon.tenMonHoc || '').toLowerCase().includes(tuKhoa)
  );
  if (duLieuLoc.length === 0 && bangDiem.length === 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 8;
      cell.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng m·ªü kh√≥a ho·∫∑c th√™m m√¥n.";
      cell.style.textAlign = 'center';
  } else if (duLieuLoc.length === 0 && bangDiem.length > 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 8;
      cell.textContent = "Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc ph√π h·ª£p v·ªõi t·ª´ kh√≥a c·ªßa b·∫°n.";
      cell.style.textAlign = 'center';
  } else {
      duLieuLoc.forEach(mon => {
          const originalIndex = bangDiem.findIndex(item => item.maMonHoc === mon.maMonHoc);
          const row = document.createElement("tr");
          row.dataset.originalIndex = originalIndex;
          row.innerHTML = `
            <td contenteditable="true" data-field="maMonHoc">${mon.maMonHoc}</td>
            <td contenteditable="true" data-field="tenMonHoc">${mon.tenMonHoc}</td>
            <td contenteditable="true" data-field="soTinChi">${mon.soTinChi}</td>
            <td contenteditable="true" data-field="diemHe10">${mon.diemHe10}</td>
            <td>${tinhDiemHe4(mon.diemHe10).toFixed(1)}</td>
            <td>${xepLoai(mon.diemHe10)}</td>
            <td style="color:${mon.diemHe10 >= 4.0 ? 'green':'red'}; font-weight:bold;">${mon.diemHe10 >= 4.0 ? 'ƒê·∫°t' : 'Kh√¥ng ƒê·∫°t'}</td>
            <td><button class="btn-xoa-hang">X√≥a</button></td>
          `;
          tbody.appendChild(row);
      });
  }
  addEventListenersToTable();
}

function addEventListenersToTable() {
    document.querySelectorAll("#body-bang-diem tr[data-original-index]").forEach(row => {
        const index = parseInt(row.dataset.originalIndex, 10);
        if (isNaN(index) || index < 0 || !bangDiem[index]) return;
        
        row.querySelector(".btn-xoa-hang").addEventListener("click", () => {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n "${bangDiem[index].tenMonHoc}"?`)) {
                bangDiem.splice(index, 1);
                capNhatBang();
                tinhDiemTongKet();
            }
        });

        row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
            cell.addEventListener('blur', (e) => {
                const field = e.target.dataset.field;
                let newValue = e.target.textContent.trim();
                const monHoc = bangDiem[index];
                if (!monHoc) return;
                const oldValue = monHoc[field];

                if (String(oldValue) === newValue) return;

                if (field === 'soTinChi' || field === 'diemHe10') {
                    const numValue = parseFloat(newValue);
                    if (field === 'soTinChi' && (isNaN(numValue) || numValue < 1 || numValue > 4)) {
                        alert("S·ªë t√≠n ch·ªâ ph·∫£i l√† m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 4.");
                        e.target.textContent = oldValue;
                        return;
                    }
                    if (field === 'diemHe10' && (isNaN(numValue) || numValue < 0 || numValue > 10)) {
                        alert("ƒêi·ªÉm h·ªá 10 ph·∫£i l√† m·ªôt s·ªë t·ª´ 0 ƒë·∫øn 10.");
                        e.target.textContent = oldValue;
                        return;
                    }
                     monHoc[field] = numValue;
                } else {
                    monHoc[field] = newValue;
                }
                capNhatBang();
                tinhDiemTongKet();
            });
             cell.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });
        });
    });
}
function tinhDiemTongKet() {
  let tongDiemTichLuy = 0, tongTin = 0;
  // Ch·ªâ t√≠nh ƒëi·ªÉm cho c√°c m√¥n ƒë·∫°t (ƒëi·ªÉm >= 4.0)
  const monHocTinhDiem = bangDiem.filter(m => m.diemHe10 >= 4.0);
  monHocTinhDiem.forEach(m => {
    tongDiemTichLuy += tinhDiemHe4(m.diemHe10) * m.soTinChi;
    tongTin += parseFloat(m.soTinChi) || 0;
  });
  document.getElementById("tong-tin-chi").textContent = `T·ªïng s·ªë t√≠n ch·ªâ t√≠ch l≈©y: ${tongTin}`;
  if (tongTin > 0) {
    const diemTB = (tongDiemTichLuy / tongTin).toFixed(2);
    document.getElementById("diem-trung-binh-tich-luy").textContent = `ƒêi·ªÉm TB t√≠ch l≈©y (h·ªá 4): ${diemTB}`;
  } else {
    document.getElementById("diem-trung-binh-tich-luy").textContent = "ƒêi·ªÉm TB t√≠ch l≈©y (h·ªá 4): N/A";
  }
}

document.getElementById("searchBox").addEventListener("input", capNhatBang);
document.getElementById("btn-tinh-diem-trung-binh").addEventListener("click", tinhDiemTongKet);

document.getElementById("form-them-mon").addEventListener("submit", function(e) {
  e.preventDefault();
  const thongBao = document.getElementById("thong-bao");
  let ma = document.getElementById("ma-mon-hoc").value.trim().toUpperCase();
  let ten = document.getElementById("ten-mon-hoc").value.trim();
  let tin = parseFloat(document.getElementById("so-tin-chi").value);
  let diem10 = parseFloat(document.getElementById("diem-he-10").value);
  thongBao.textContent = "";

  if (!ma || !ten || isNaN(tin) || isNaN(diem10)) {
    thongBao.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c th√¥ng tin."; return;
  }
  if (tin < 1 || tin > 4) {
      thongBao.textContent = "S·ªë t√≠n ch·ªâ ph·∫£i l√† m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 4.";
      document.getElementById("so-tin-chi").focus();
      return;
  }
  if (diem10 < 0 || diem10 > 10) {
      thongBao.textContent = "ƒêi·ªÉm h·ªá 10 ph·∫£i l√† m·ªôt s·ªë t·ª´ 0 ƒë·∫øn 10.";
      document.getElementById("diem-he-10").focus();
      return;
  }
  if (bangDiem.some(mon => mon.maMonHoc === ma)) {
    thongBao.textContent = `M√£ m√¥n h·ªçc "${ma}" ƒë√£ t·ªìn t·∫°i.`; return;
  }

  bangDiem.push({ maMonHoc: ma, tenMonHoc: ten, soTinChi: tin, diemHe10: diem10 });
  capNhatBang();
  tinhDiemTongKet();
  this.reset();
  document.getElementById("ma-mon-hoc").focus();
});

document.getElementById("btn-xoa").addEventListener("click", function(e) {
  e.preventDefault();
  if (bangDiem.length > 0 && confirm("Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n b·∫£ng. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) {
    bangDiem = [];
    capNhatBang();
    tinhDiemTongKet();
  }
});

document.getElementById("btn-luu").addEventListener("click", function(e) {
  e.preventDefault();
  if (bangDiem.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u."); return; }
  
  let content = "B·∫¢NG ƒêI·ªÇM T·ªîNG H·ª¢P\n====================\n\n";
  bangDiem.forEach(m => {
    content += `----------------------------------------\n`;
    content += `M√£ m√¥n h·ªçc: ${m.maMonHoc}\nT√™n m√¥n h·ªçc: ${m.tenMonHoc}\n`;
    content += `S·ªë t√≠n ch·ªâ: ${m.soTinChi}\nƒêi·ªÉm h·ªá 10: ${m.diemHe10}\n`;
    content += `ƒêi·ªÉm h·ªá 4: ${tinhDiemHe4(m.diemHe10).toFixed(1)}\nX·∫øp lo·∫°i: ${xepLoai(m.diemHe10)}\nTr·∫°ng th√°i: ${m.diemHe10 >= 4.0 ? 'ƒê·∫°t' : 'Kh√¥ng ƒê·∫°t'}\n\n`;
  });
  
  const tongTin = bangDiem.filter(m => m.diemHe10 >= 4.0).reduce((sum, m) => sum + m.soTinChi, 0);
  const tongDiemTichLuy = bangDiem.filter(m => m.diemHe10 >= 4.0).reduce((sum, m) => sum + tinhDiemHe4(m.diemHe10) * m.soTinChi, 0);
  const diemTB = tongTin > 0 ? (tongDiemTichLuy / tongTin).toFixed(2) : "N/A";
  
  content += `====================\nT·ªîNG K·∫æT:\n`;
  content += `T·ªïng s·ªë t√≠n ch·ªâ t√≠ch l≈©y: ${tongTin}\n`;
  content += `ƒêi·ªÉm TB t√≠ch l≈©y (h·ªá 4): ${diemTB}\n`;

  let blob = new Blob(["\uFEFF" + content], {type: "application/msword;charset=utf-8"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "bang-diem-tong-hop.doc";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
});


document.getElementById("btn-save-github").addEventListener("click", function() {
    if (bangDiem.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u. Vui l√≤ng th√™m m√¥n h·ªçc tr∆∞·ªõc.");
        return;
    }

    const mk = prompt("üîê Nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n ƒë·ªÉ x√°c minh v√† l∆∞u d·ªØ li·ªáu:", "");
    if (mk === null || mk.trim() === "") {
        alert("‚ùå Thao t√°c ƒë√£ b·ªã h·ªßy.");
        return;
    }

    const keyCheckUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/keycheck.enc?timestamp=${new Date().getTime()}`;

    fetch(keyCheckUrl)
    .then(res => {
        if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file keycheck.enc tr√™n GitHub.");
        return res.text();
    })
    .then(encryptedCheck => {
        try {
            const decrypted = CryptoJS.AES.decrypt(encryptedCheck, mk).toString(CryptoJS.enc.Utf8);
            if (JSON.parse(decrypted) !== "VALID_ADMIN_KEY") {
                throw new Error("Invalid key content");
            }

            alert("‚úÖ M·∫≠t kh·∫©u h·ª£p l·ªá. ƒêang chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t...");
            
            const duLieuJSON = JSON.stringify(bangDiem, null, 2);
            const duLieuMaHoa = CryptoJS.AES.encrypt(duLieuJSON, mk).toString();

            navigator.clipboard.writeText(duLieuMaHoa).then(() => {
                alert("D·ªØ li·ªáu m·ªõi ƒë√£ ƒë∆∞·ª£c m√£ h√≥a v√† sao ch√©p v√†o clipboard.\n\nüëâ B√¢y gi·ªù b·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang ch·ªânh s·ª≠a. H√£y d√°n (Ctrl+V) ƒë·ªÉ thay th·∫ø n·ªôi dung c≈© v√† nh·∫•n 'Commit changes'.");
                const githubEditUrl = `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/edit/${GITHUB_BRANCH}/data.enc`;
                window.open(githubEditUrl, '_blank');
            }).catch(err => {
                console.error('L·ªói sao ch√©p:', err);
                alert('‚ùå Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng d√πng c√¥ng c·ª• m√£ h√≥a th·ªß c√¥ng.');
            });

        } catch (e) {
            console.error("L·ªói x√°c th·ª±c:", e);
            alert("‚ùå M·∫≠t kh·∫©u sai. B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y!");
        }
    })
    .catch(err => {
        console.error("L·ªói khi t·∫£i keycheck.enc:", err);
        alert("‚ùå ƒê√£ x·∫£y ra l·ªói khi x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi m·∫°ng ho·∫∑c th√¥ng b√°o cho Admin.");
    });
});

document.getElementById("btn-thoat").addEventListener("click", function(e) {
  e.preventDefault();
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng tab n√†y?")) {
    window.close();
  }
});

document.getElementById('file-upload').addEventListener('change', function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const feedbackEl = document.getElementById('upload-feedback');
    feedbackEl.textContent = 'ƒêang x·ª≠ l√Ω file...';
    feedbackEl.style.color = '#004AAD';

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            if (jsonData.length === 0) throw new Error("File Excel tr·ªëng.");

            const requiredCols = ['MaMonHoc', 'TenMonHoc', 'SoTinChi', 'DiemHe10'];
            const header = Object.keys(jsonData[0]);
            for (const col of requiredCols) {
                if (!header.includes(col)) {
                     throw new Error(`File Excel thi·∫øu c·ªôt b·∫Øt bu·ªôc: "${col}".`);
                }
            }
            
            const duLieuMoi = jsonData.map(row => {
                const maMonHoc = String(row.MaMonHoc || '').trim().toUpperCase();
                const tenMonHoc = String(row.TenMonHoc || '').trim();
                const soTinChi = parseFloat(row.SoTinChi);
                const diemHe10 = parseFloat(row.DiemHe10);
                if (!maMonHoc || !tenMonHoc || isNaN(soTinChi) || isNaN(diemHe10) || soTinChi < 1 || soTinChi > 4 || diemHe10 < 0 || diemHe10 > 10) return null; 
                return { maMonHoc, tenMonHoc, soTinChi, diemHe10 };
            }).filter(item => item !== null);

            if (duLieuMoi.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file Excel (ki·ªÉm tra l·∫°i c√°c c·ªôt v√† gi√° tr·ªã).");

            if (bangDiem.length > 0 && !confirm("B·∫°n mu·ªën THAY TH·∫æ d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu t·ª´ file? (Nh·∫•n 'Cancel' ƒë·ªÉ N·ªêI TH√äM v√†o cu·ªëi danh s√°ch)")) {
                duLieuMoi.forEach(monMoi => {
                    if (!bangDiem.some(monCu => monCu.maMonHoc === monMoi.maMonHoc)) {
                        bangDiem.push(monMoi);
                    }
                });
            } else {
                bangDiem = duLieuMoi;
            }

            capNhatBang();
            tinhDiemTongKet();
            feedbackEl.textContent = `T·∫£i l√™n v√† x·ª≠ l√Ω th√†nh c√¥ng ${duLieuMoi.length} m√¥n h·ªçc!`;
            feedbackEl.style.color = '#28a745';
        } catch (err) {
            feedbackEl.textContent = 'L·ªói: ' + err.message;
            feedbackEl.style.color = 'red';
        } finally {
            event.target.value = ''; // Reset file input
        }
    };
    reader.onerror = () => {
        feedbackEl.textContent = 'L·ªói khi ƒë·ªçc file.';
        feedbackEl.style.color = 'red';
    };
    reader.readAsArrayBuffer(file);
});

document.getElementById('btn-download-json').addEventListener('click', downloadJsonData);

// === PH·∫¶N SCRIPT M·ªöI ƒê∆Ø·ª¢C TH√äM V√ÄO ===
document.getElementById('json-upload').addEventListener('change', function handleJsonFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const feedbackEl = document.getElementById('json-upload-feedback');
    feedbackEl.textContent = 'ƒêang x·ª≠ l√Ω file...';
    feedbackEl.style.color = '#004AAD';

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);

            // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
            if (!Array.isArray(jsonData) || jsonData.length === 0) throw new Error("File JSON kh√¥ng h·ª£p l·ªá ho·∫∑c tr·ªëng.");
            const requiredKeys = ['maMonHoc', 'tenMonHoc', 'soTinChi', 'diemHe10'];
            const duLieuMoi = jsonData.map(row => {
                // Ki·ªÉm tra s·ª± t·ªìn t·∫°i v√† t√≠nh h·ª£p l·ªá c·ªßa t·ª´ng key
                if (!requiredKeys.every(k => row.hasOwnProperty(k)) ||
                    typeof row.maMonHoc !== 'string' ||
                    typeof row.tenMonHoc !== 'string' ||
                    isNaN(parseFloat(row.soTinChi)) ||
                    isNaN(parseFloat(row.diemHe10))) {
                    return null; // B·ªè qua h√†ng kh√¥ng h·ª£p l·ªá
                }
                // Chu·∫©n h√≥a d·ªØ li·ªáu
                return {
                    maMonHoc: row.maMonHoc.trim().toUpperCase(),
                    tenMonHoc: row.tenMonHoc.trim(),
                    soTinChi: parseFloat(row.soTinChi),
                    diemHe10: parseFloat(row.diemHe10)
                };
            }).filter(item => item !== null); // L·ªçc ra c√°c h√†ng h·ª£p l·ªá

            if (duLieuMoi.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file JSON.");

            if (bangDiem.length > 0 && !confirm("B·∫°n mu·ªën THAY TH·∫æ d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu t·ª´ file? (Nh·∫•n 'Cancel' ƒë·ªÉ N·ªêI TH√äM v√†o cu·ªëi danh s√°ch)")) {
                duLieuMoi.forEach(monMoi => {
                    // Ch·ªâ th√™m n·∫øu m√£ m√¥n h·ªçc ch∆∞a t·ªìn t·∫°i ƒë·ªÉ tr√°nh tr√πng l·∫∑p
                    if (!bangDiem.some(monCu => monCu.maMonHoc === monMoi.maMonHoc)) {
                        bangDiem.push(monMoi);
                    }
                });
            } else {
                bangDiem = duLieuMoi;
            }

            capNhatBang();
            tinhDiemTongKet();
            feedbackEl.textContent = `T·∫£i l√™n v√† x·ª≠ l√Ω th√†nh c√¥ng ${duLieuMoi.length} m√¥n h·ªçc!`;
            feedbackEl.style.color = '#28a745';
        } catch (err) {
            feedbackEl.textContent = 'L·ªói: ' + err.message;
            feedbackEl.style.color = 'red';
        } finally {
            event.target.value = ''; // Reset input ƒë·ªÉ c√≥ th·ªÉ t·∫£i l·∫°i c√πng file
        }
    };
    reader.onerror = () => {
        feedbackEl.textContent = 'L·ªói khi ƒë·ªçc file.';
        feedbackEl.style.color = 'red';
    };
    reader.readAsText(file);
});
// === K·∫æT TH√öC PH·∫¶N SCRIPT M·ªöI ===

</script>
</body>
</html>
