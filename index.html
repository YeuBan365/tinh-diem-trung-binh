<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√≠nh ƒëi·ªÉm trung b√¨nh HUTECH - Ho√†n Ch·ªânh</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
        --primary-color: #004AAD;
        --secondary-color: #00337d;
        --light-bg: #eef4fb;
        --card-bg: #ffffff;
        --text-color: #333;
        --border-color: #ddd;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    .navbar {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 1000;
    }
    .navbar h1 { margin: 0; font-size: 20px; }
    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }
    .unlock-area {
      background-color: #fffbe6;
      border: 1px solid #ffe58f;
    }
    h2, h3 { 
      margin-top: 0; 
      color: var(--primary-color); 
      border-bottom: 2px solid var(--light-bg); 
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    label { font-weight: bold; display: block; margin: 12px 0 6px; }
    input, select {
      box-sizing: border-box;
      padding: 12px;
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 10px;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-size: 16px;
    }
    input:focus, select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.2);
        outline: none;
    }
    #searchBox { margin-bottom: 20px; }
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      margin: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 15px;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:hover { background: var(--secondary-color); transform: translateY(-2px); }
    button:active { transform: translateY(0); }
    .form-buttons {
        display: flex;
        flex-wrap: wrap;
        margin: 10px -5px 0;
    }
    button.btn-xoa-hang {
        background-color: var(--danger-color); padding: 6px 12px; font-size: 14px;
        margin: 0;
    }
    button#btn-xoa { background-color: var(--danger-color); }
    button#btn-save-github { background-color: var(--success-color); }
    button#btn-thoat { background-color: #6c757d; }
    button#btn-xuat-pdf { background-color: #ff6f00; }
    button#btn-cai-thien-diem { background-color: var(--info-color); }
    button#btn-download-json { background-color: #007bff;}
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        text-align: left;
        vertical-align: middle;
    }
    th {
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
    }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #f1f1f1; }
    td[contenteditable="true"] {
        background-color: #ffffff;
        cursor: text;
    }
    td[contenteditable="true"]:focus {
        background-color: #e6f7ff;
        outline: 2px solid var(--primary-color);
    }
    #result-container {
        margin-top: 20px;
        padding: 20px;
        background: #f0f8ff;
        border-radius: 8px;
        border: 1px solid var(--primary-color);
    }
    .result-item {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-color);
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
    }
    .result-item span {
      font-weight: normal;
      color: var(--text-color);
      text-align: right;
    }
    @media (max-width: 768px) {
        .container {
            margin-top: 20px;
            padding: 0 15px;
        }
        .navbar h1 { font-size: 16px; }
        h2 { font-size: 22px; }
        table thead {
            display: none;
        }
        table, tbody, tr, td {
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        tr {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        td {
            border: none;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
        }
        td:not(:last-child) {
            border-bottom: 1px dashed #eee;
        }
        td::before {
            content: attr(data-label);
            font-weight: bold;
            text-align: left;
            margin-right: 10px;
            color: var(--primary-color);
        }
        td[data-label="Thao t√°c"] {
            justify-content: center;
        }
        td[data-label="Thao t√°c"]::before {
            display: none;
        }
        #upload-section h3, #upload-section p {
            text-align: center;
        }
        #upload-section input[type="file"] {
            font-size: 14px;
        }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üéì H·ªá th·ªëng T√≠nh ƒêi·ªÉm HUTECH</h1>
  </div>
  <div class="container">
    <div id="unlock-section" class="card unlock-area">
      <h2>M·ªü kh√≥a D·ªØ li·ªáu Admin</h2>
      <p>D·ªØ li·ªáu c·ªßa Admin ƒë∆∞·ª£c m√£ h√≥a. Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ t·∫£i v√† gi·∫£i m√£.</p>
      <label for="matKhau">M·∫≠t kh·∫©u c·ªßa Admin:</label>
      <input type="password" id="matKhau" placeholder="Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a..." onkeydown="if(event.key==='Enter') taiVaGiaiMaDuLieu()">
      <div class="form-buttons">
          <button onclick="taiVaGiaiMaDuLieu()">üîë M·ªü kh√≥a</button>
          <a href="https://yeuban365.github.io/tinh-diem-trung-binh/encrypt.html" target="_blank" style="text-decoration: none; margin: 5px;">
              <button type="button" style="background-color: var(--info-color); width: 100%;">‚öôÔ∏è C√¥ng c·ª• M√£ h√≥a</button>
          </a>
          <button type="button" id="btn-download-json" style="background-color: #007bff;">üì• T·∫£i .json</button>
          <button type="button" id="btn-thoat">üö™ Tho√°t</button>
      </div>
      <p id="unlock-feedback"></p>
    </div>
    <div class="card">
      <h2>Nh·∫≠p H·ªçc ph·∫ßn</h2>
      <form id="form-them-mon">
          <label for="ma-mon-hoc">M√£ m√¥n h·ªçc:</label>
          <input type="text" id="ma-mon-hoc" required>
          <label for="ten-mon-hoc">T√™n m√¥n h·ªçc:</label>
          <input type="text" id="ten-mon-hoc" required>
          <label for="so-tin-chi">S·ªë t√≠n ch·ªâ (1-4):</label>
          <input type="number" id="so-tin-chi" min="1" max="4" required>
          <label for="diem-he-10">ƒêi·ªÉm h·ªá s·ªë 10:</label>
          <input type="number" id="diem-he-10" step="0.1" min="0" max="10" required>
          <div class="form-buttons">
              <button type="submit" id="btn-them-mon-hoc">‚ûï Th√™m m√¥n</button>
              <button type="button" id="btn-tinh-diem-trung-binh">üìä T√≠nh ƒëi·ªÉm</button>
              <button type="button" id="btn-xoa">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
              <button type="button" id="btn-xuat-pdf">üìÑ Xu·∫•t PDF</button>
              <button type="button" id="btn-save-github">üíæ L∆∞u [Admin]</button>
          </div>
      </form>
      <p id="thong-bao" style="color: red; font-weight: bold;"></p>
       <div id="upload-section" style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px;">
        <h3>Ho·∫∑c t·∫£i l√™n t·ª´ file</h3>
        <p><em>H·ªó tr·ª£ file Excel (.xlsx) ho·∫∑c JSON (.json)</em></p>
        <label for="file-upload">T·∫£i file Excel:</label>
        <input type="file" id="file-upload" accept=".xlsx, .xls">
        <p id="upload-feedback"></p>
        <label for="json-upload">T·∫£i file JSON:</label>
        <input type="file" id="json-upload" accept=".json">
        <p id="json-upload-feedback"></p>
      </div>
    </div>
    <div class="card">
        <h2>C√¥ng c·ª• L·∫≠p k·∫ø ho·∫°ch</h2>
        <p>S·ª≠ d·ª•ng c√¥ng c·ª• n√†y ƒë·ªÉ ph√¢n t√≠ch v√† l·∫≠p k·∫ø ho·∫°ch c·∫£i thi·ªán ƒëi·ªÉm s·ªë nh·∫±m ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u h·ªçc t·∫≠p c·ªßa b·∫°n.</p>
        <div class="form-buttons">
            <button id="btn-cai-thien-diem">üöÄ M·ªü C√¥ng c·ª• C·∫£i thi·ªán ƒêi·ªÉm</button>
        </div>
    </div>
    <div class="card">
      <h2>B·∫£ng ƒëi·ªÉm Chi ti·∫øt</h2>
      <p><em>M·∫πo: B·∫°n c√≥ th·ªÉ s·ª≠a tr·ª±c ti·∫øp tr√™n b·∫£ng. Tr√™n mobile, b·∫£ng s·∫Ω hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng danh s√°ch.</em></p>
      <input id="searchBox" placeholder="üîç T√¨m ki·∫øm m√£ ho·∫∑c t√™n m√¥n...">
      <table>
        <thead>
          <tr>
            <th>M√£ m√¥n h·ªçc</th>
            <th>T√™n m√¥n h·ªçc</th>
            <th>S·ªë TC</th>
            <th>ƒêi·ªÉm 10</th>
            <th>ƒêi·ªÉm 4</th>
            <th>X·∫øp lo·∫°i</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="body-bang-diem"></tbody>
      </table>
      <div id="result-container">
          <p class="result-item" id="tong-tin-chi">T·ªïng s·ªë t√≠n ch·ªâ t√≠ch l≈©y: <span>0</span></p>
          <p class="result-item" id="diem-trung-binh-tich-luy">ƒêi·ªÉm TB t√≠ch l≈©y (h·ªá 4): <span>0.00</span></p>
          <p class="result-item" id="xep-loai-toan-khoa">X·∫øp lo·∫°i h·ªçc l·ª±c to√†n kh√≥a: <span>Ch∆∞a ƒë·ªß d·ªØ li·ªáu</span></p>
      </div>
    </div>
  </div>

<script>
let bangDiem = [];
const GITHUB_USER = 'YeuBan365';
const GITHUB_REPO = 'tinh-diem-trung-binh';
const GITHUB_BRANCH = 'main';

const tinhDiemHe4 = d => (d >= 8.5) ? 4.0 : (d >= 7.8) ? 3.5 : (d >= 7.0) ? 3.0 : (d >= 6.3) ? 2.5 : (d >= 5.5) ? 2.0 : (d >= 4.8) ? 1.5 : (d >= 4.0) ? 1.0 : 0.0;
const xepLoaiMon = d => (d >= 8.5) ? "A (Gi·ªèi)" : (d >= 7.8) ? "B+ (Kh√°)" : (d >= 7.0) ? "B (Kh√°)" : (d >= 6.3) ? "C+ (TB)" : (d >= 5.5) ? "C (TB)" : (d >= 4.8) ? "D+ (Y·∫øu)" : (d >= 4.0) ? "D (Y·∫øu)" : "F (R·ªõt)";

function xepLoaiToanKhoa(gpa) {
    if (gpa >= 3.6) return { loai: "Xu·∫•t s·∫Øc", mau: "#1e9e74" };
    if (gpa >= 3.2) return { loai: "Gi·ªèi", mau: "#28a745" };
    if (gpa >= 2.5) return { loai: "Kh√°", mau: "#007bff" };
    if (gpa >= 2.0) return { loai: "Trung b√¨nh", mau: "#ffc107" };
    return { loai: "Y·∫øu", mau: "#dc3545" };
}

function capNhatBang() {
  const tuKhoa = document.getElementById("searchBox").value.toLowerCase().trim();
  const tbody = document.getElementById("body-bang-diem");
  tbody.innerHTML = "";
  const duLieuLoc = bangDiem.filter(mon =>
      (mon.maMonHoc || '').toLowerCase().includes(tuKhoa) ||
      (mon.tenMonHoc || '').toLowerCase().includes(tuKhoa)
  );
  if (duLieuLoc.length === 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 8;
      cell.textContent = bangDiem.length === 0 ? "Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng th√™m m√¥n ho·∫∑c m·ªü kh√≥a." : "Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc ph√π h·ª£p.";
      cell.style.textAlign = 'center';
      cell.style.padding = '20px';
  } else {
      duLieuLoc.forEach(mon => {
          const originalIndex = bangDiem.findIndex(item => item === mon);
          const row = document.createElement("tr");
          row.dataset.originalIndex = originalIndex;
          row.innerHTML = `
            <td data-label="M√£ m√¥n h·ªçc" contenteditable="true" data-field="maMonHoc">${mon.maMonHoc}</td>
            <td data-label="T√™n m√¥n h·ªçc" contenteditable="true" data-field="tenMonHoc">${mon.tenMonHoc}</td>
            <td data-label="S·ªë TC" contenteditable="true" data-field="soTinChi">${mon.soTinChi}</td>
            <td data-label="ƒêi·ªÉm 10" contenteditable="true" data-field="diemHe10">${mon.diemHe10}</td>
            <td data-label="ƒêi·ªÉm 4">${tinhDiemHe4(mon.diemHe10).toFixed(1)}</td>
            <td data-label="X·∫øp lo·∫°i">${xepLoaiMon(mon.diemHe10)}</td>
            <td data-label="Tr·∫°ng th√°i" style="color:${mon.diemHe10 >= 4.0 ? 'green':'red'}; font-weight:bold;">${mon.diemHe10 >= 4.0 ? 'ƒê·∫°t' : 'Kh√¥ng ƒê·∫°t'}</td>
            <td data-label="Thao t√°c"><button class="btn-xoa-hang">X√≥a</button></td>
          `;
          tbody.appendChild(row);
      });
  }
  addEventListenersToTable();
}

function tinhDiemTongKet() {
  let tongDiemTichLuy = 0, tongTin = 0;
  const monHocTinhDiem = bangDiem.filter(m => m.diemHe10 >= 4.0);
  
  monHocTinhDiem.forEach(m => {
    tongDiemTichLuy += tinhDiemHe4(m.diemHe10) * m.soTinChi;
    tongTin += parseFloat(m.soTinChi) || 0;
  });

  const diemTB = (tongTin > 0) ? (tongDiemTichLuy / tongTin) : 0;
  
  document.getElementById("tong-tin-chi").innerHTML = `T·ªïng s·ªë t√≠n ch·ªâ t√≠ch l≈©y: <span>${tongTin}</span>`;
  document.getElementById("diem-trung-binh-tich-luy").innerHTML = `ƒêi·ªÉm TB t√≠ch l≈©y (h·ªá 4): <span>${diemTB.toFixed(2)}</span>`;

  const xepLoai = xepLoaiToanKhoa(diemTB);
  const xepLoaiElement = document.getElementById("xep-loai-toan-khoa");
  if(tongTin > 0){
      xepLoaiElement.innerHTML = `X·∫øp lo·∫°i h·ªçc l·ª±c to√†n kh√≥a: <span style="color: ${xepLoai.mau}; font-weight: bold;">${xepLoai.loai}</span>`;
  } else {
      xepLoaiElement.innerHTML = `X·∫øp lo·∫°i h·ªçc l·ª±c to√†n kh√≥a: <span>Ch∆∞a ƒë·ªß d·ªØ li·ªáu</span>`;
  }
}

// *** H√ÄM XU·∫§T PDF PHI√äN B·∫¢N CHUY√äN NGHI·ªÜP: KI·ªÇM SO√ÅT PH√ÇN TRANG TUY·ªÜT ƒê·ªêI ***
function xuatBangDiemPDF_ChuyenNghiep() {
    if (bangDiem.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t file PDF.");
        return;
    }

    // --- T√≠nh to√°n th√¥ng tin t·ªïng k·∫øt ---
    const monDat = bangDiem.filter(m => m.diemHe10 >= 4.0);
    const tongTinDat = monDat.reduce((sum, m) => sum + m.soTinChi, 0);
    const tongDiemNhanTinChi = monDat.reduce((sum, m) => sum + (tinhDiemHe4(m.diemHe10) * m.soTinChi), 0);
    const gpa = tongTinDat > 0 ? (tongDiemNhanTinChi / tongTinDat) : 0;
    const xepLoaiChung = xepLoaiToanKhoa(gpa);

    // --- C·∫•u tr√∫c HTML cho t·ª´ng th√†nh ph·∫ßn ---
    const tableHeaderHTML = `
        <thead>
            <tr>
                <th>STT</th>
                <th>M√£ HP</th>
                <th>T√™n H·ªçc Ph·∫ßn</th>
                <th>S·ªë TC</th>
                <th>ƒêi·ªÉm 10</th>
                <th>ƒêi·ªÉm 4</th>
                <th>X·∫øp Lo·∫°i</th>
            </tr>
        </thead>`;
    
    const summaryHTML = `
        <div class="pdf-summary">
            <h3>T·ªîNG K·∫æT</h3>
            <p><strong>T·ªïng s·ªë t√≠n ch·ªâ ƒë√£ h·ªçc:</strong> ${bangDiem.reduce((sum, m) => sum + m.soTinChi, 0)}</p>
            <p><strong>T·ªïng s·ªë t√≠n ch·ªâ t√≠ch l≈©y:</strong> ${tongTinDat}</p>
            <p><strong>ƒêi·ªÉm trung b√¨nh t√≠ch l≈©y (H·ªá 4):</strong> ${gpa.toFixed(2)}</p>
            <p><strong>X·∫øp lo·∫°i h·ªçc l·ª±c to√†n kh√≥a:</strong> ${xepLoaiChung.loai}</p>
        </div>`;

    // --- X√¢y d·ª±ng n·ªôi dung PDF theo t·ª´ng trang ---
    let allPagesHTML = '';
    const ROWS_PER_PAGE = 38; // ∆Ø·ªõc t√≠nh s·ªë d√≤ng t·ªëi ƒëa tr√™n m·ªói trang A4
    const totalPages = Math.ceil(bangDiem.length / ROWS_PER_PAGE);

    for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
        const startIndex = pageIndex * ROWS_PER_PAGE;
        const endIndex = startIndex + ROWS_PER_PAGE;
        const pageData = bangDiem.slice(startIndex, endIndex);

        const tableRowsHTML = pageData.map((mon, index) => `
            <tr>
                <td>${startIndex + index + 1}</td>
                <td>${mon.maMonHoc}</td>
                <td class="ten-mon">${mon.tenMonHoc}</td>
                <td>${mon.soTinChi}</td>
                <td>${mon.diemHe10.toFixed(1)}</td>
                <td>${tinhDiemHe4(mon.diemHe10).toFixed(1)}</td>
                <td>${xepLoaiMon(mon.diemHe10)}</td>
            </tr>
        `).join('');

        allPagesHTML += `
            <div class="pdf-page">
                <div class="pdf-header">
                    <h1>B·∫¢NG ƒêI·ªÇM H·ªåC T·∫¨P</h1>
                    <p>Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}</p>
                </div>
                <table class="pdf-table">
                    ${tableHeaderHTML}
                    <tbody>${tableRowsHTML}</tbody>
                </table>
                <div class="pdf-footer">Trang ${pageIndex + 1} / ${totalPages}</div>
            </div>
        `;
    }

    // --- T·∫°o n·ªôi dung HTML ho√†n ch·ªânh ---
    const pdfContent = `
        <div id="pdf-export-content">
            <style>
                #pdf-export-content { font-family: 'Roboto', sans-serif; color: #333; }
                .pdf-page { page-break-after: always; display: flex; flex-direction: column; height: 98%; }
                .pdf-header { text-align: center; }
                .pdf-header h1 { color: #004AAD; margin: 0; font-size: 20px; }
                .pdf-table { width: 100%; border-collapse: collapse; }
                .pdf-table th, .pdf-table td { border: 1px solid #ccc; padding: 4px 6px; font-size: 9px; text-align: center; vertical-align: middle; }
                .pdf-table th { background-color: #f2f2f2; font-weight: bold; }
                .pdf-table .ten-mon { text-align: left; }
                .pdf-footer { text-align: center; font-size: 9px; color: #888; margin-top: auto; padding-top: 10px; }
                .pdf-summary { page-break-before: always; padding-top: 20px; }
                .pdf-summary h3 { color: #004AAD; margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                .pdf-summary p { margin: 6px 0; font-size: 12px; }
            </style>
            ${allPagesHTML}
            ${summaryHTML}
        </div>
    `;
    
    // --- Xu·∫•t PDF ---
    const element = document.createElement('div');
    element.style.position = 'absolute';
    element.style.left = '-9999px';
    element.innerHTML = pdfContent;
    document.body.appendChild(element);
    
    const exportTarget = element.querySelector('#pdf-export-content');
    const opt = {
        margin:       0.4,
        filename:     'Bang_Diem_HUTECH_Chuan.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, letterRendering: true, logging: false },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(exportTarget).set(opt).save().then(() => {
        document.body.removeChild(element);
    });
}


// === C√ÅC H√ÄM KH√ÅC GI·ªÆ NGUY√äN ===
document.addEventListener('DOMContentLoaded', () => {
    capNhatBang();
    tinhDiemTongKet();
});
// Thay ƒë·ªïi s·ª± ki·ªán click ƒë·ªÉ g·ªçi h√†m chuy√™n nghi·ªáp
document.getElementById("btn-xuat-pdf").addEventListener("click", xuatBangDiemPDF_ChuyenNghiep);

// ... To√†n b·ªô c√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n nh∆∞ code tr∆∞·ªõc ...
// (taiVaGiaiMaDuLieu, addEventListenersToTable, c√°c s·ª± ki·ªán click, v.v...)
document.getElementById('btn-cai-thien-diem').addEventListener('click', function() { if (bangDiem.length === 0) { alert("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt m√¥n h·ªçc tr∆∞·ªõc khi s·ª≠ d·ª•ng c√¥ng c·ª• n√†y."); return; } localStorage.setItem('bangDiemData', JSON.stringify(bangDiem)); window.open('cai-thien-diem.html', '_blank'); }); function taiVaGiaiMaDuLieu() { const mk = document.getElementById("matKhau").value; const feedback = document.getElementById("unlock-feedback"); if (!mk) { feedback.style.color = 'red'; feedback.textContent = "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!"; return; } if (bangDiem.length > 0 && !confirm("Thao t√°c n√†y s·∫Ω ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i tr√™n b·∫£ng. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) { return; } feedback.textContent = "ƒêang t·∫£i v√† gi·∫£i m√£ d·ªØ li·ªáu..."; feedback.style.color = '#004AAD'; const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data.enc?timestamp=${new Date().getTime()}`; fetch(url) .then(res => { if (!res.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i file d·ªØ li·ªáu! Status: ${res.status}`); return res.text(); }) .then(encryptedData => { try { const bytes = CryptoJS.AES.decrypt(encryptedData, mk); const originalText = bytes.toString(CryptoJS.enc.Utf8); if (!originalText) throw new Error("Sai m·∫≠t kh·∫©u ho·∫∑c d·ªØ li·ªáu b·ªã l·ªói."); bangDiem = JSON.parse(originalText); capNhatBang(); tinhDiemTongKet(); feedback.textContent = "M·ªü kh√≥a v√† t·∫£i d·ªØ li·ªáu th√†nh c√¥ng!"; feedback.style.color = '#28a745'; document.getElementById("matKhau").value = ""; setTimeout(() => feedback.textContent = "", 4000); } catch (err) { console.error("L·ªói gi·∫£i m√£:", err); feedback.style.color = 'red'; feedback.textContent = "M·ªü kh√≥a th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i m·∫≠t kh·∫©u."; bangDiem = []; capNhatBang(); tinhDiemTongKet(); } }) .catch(err => { console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err); feedback.style.color = 'red'; feedback.textContent = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† ƒë∆∞·ªùng d·∫´n GitHub."; }); } function addEventListenersToTable() { document.querySelectorAll("#body-bang-diem tr[data-original-index]").forEach(row => { const index = parseInt(row.dataset.originalIndex, 10); if (isNaN(index) || index < 0 || !bangDiem[index]) return; row.querySelector(".btn-xoa-hang").addEventListener("click", () => { if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n "${bangDiem[index].tenMonHoc}"?`)) { bangDiem.splice(index, 1); capNhatBang(); tinhDiemTongKet(); } }); row.querySelectorAll('td[contenteditable="true"]').forEach(cell => { cell.addEventListener('blur', (e) => { const field = e.target.dataset.field; let newValue = e.target.textContent.trim(); const monHoc = bangDiem[index]; if (!monHoc) return; const oldValue = monHoc[field]; if (String(oldValue) === newValue) return; if (field === 'soTinChi' || field === 'diemHe10') { const numValue = parseFloat(newValue); if (field === 'soTinChi' && (isNaN(numValue) || numValue < 1 || numValue > 4)) { alert("S·ªë t√≠n ch·ªâ ph·∫£i l√† m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 4."); e.target.textContent = oldValue; return; } if (field === 'diemHe10' && (isNaN(numValue) || numValue < 0 || numValue > 10)) { alert("ƒêi·ªÉm h·ªá 10 ph·∫£i l√† m·ªôt s·ªë t·ª´ 0 ƒë·∫øn 10."); e.target.textContent = oldValue; return; } monHoc[field] = numValue; } else { monHoc[field] = newValue; } capNhatBang(); tinhDiemTongKet(); }); cell.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }); }); }); } document.getElementById("searchBox").addEventListener("input", capNhatBang); document.getElementById("btn-tinh-diem-trung-binh").addEventListener("click", tinhDiemTongKet); document.getElementById("form-them-mon").addEventListener("submit", function(e) { e.preventDefault(); const thongBao = document.getElementById("thong-bao"); let ma = document.getElementById("ma-mon-hoc").value.trim().toUpperCase(); let ten = document.getElementById("ten-mon-hoc").value.trim(); let tin = parseFloat(document.getElementById("so-tin-chi").value); let diem10 = parseFloat(document.getElementById("diem-he-10").value); thongBao.textContent = ""; if (!ma || !ten || isNaN(tin) || isNaN(diem10)) { thongBao.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c th√¥ng tin."; return; } if (tin < 1 || tin > 4) { thongBao.textContent = "S·ªë t√≠n ch·ªâ ph·∫£i l√† m·ªôt s·ªë t·ª´ 1 ƒë·∫øn 4."; document.getElementById("so-tin-chi").focus(); return; } if (diem10 < 0 || diem10 > 10) { thongBao.textContent = "ƒêi·ªÉm h·ªá 10 ph·∫£i l√† m·ªôt s·ªë t·ª´ 0 ƒë·∫øn 10."; document.getElementById("diem-he-10").focus(); return; } if (bangDiem.some(mon => mon.maMonHoc === ma)) { thongBao.textContent = `M√£ m√¥n h·ªçc "${ma}" ƒë√£ t·ªìn t·∫°i.`; return; } bangDiem.unshift({ maMonHoc: ma, tenMonHoc: ten, soTinChi: tin, diemHe10: diem10 }); capNhatBang(); tinhDiemTongKet(); this.reset(); document.getElementById("ma-mon-hoc").focus(); }); document.getElementById("btn-xoa").addEventListener("click", function(e) { e.preventDefault(); if (bangDiem.length > 0 && confirm("Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n b·∫£ng. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) { bangDiem = []; capNhatBang(); tinhDiemTongKet(); } }); function downloadJsonData() { if (bangDiem.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i v·ªÅ."); return; } const jsonData = JSON.stringify(bangDiem, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'HUTECH_BangDiem_Data.json'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } document.getElementById('btn-download-json').addEventListener('click', downloadJsonData); document.getElementById("btn-save-github").addEventListener("click", function() { if (bangDiem.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u."); return; } const mk = prompt("üîê Nh·∫≠p m·∫≠t kh·∫©u Admin ƒë·ªÉ l∆∞u d·ªØ li·ªáu:", ""); if (mk === null || mk.trim() === "") { alert("‚ùå Thao t√°c ƒë√£ b·ªã h·ªßy."); return; } const keyCheckUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/keycheck.enc?timestamp=${new Date().getTime()}`; fetch(keyCheckUrl) .then(res => { if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file keycheck.enc."); return res.text(); }) .then(encryptedCheck => { try { const decrypted = CryptoJS.AES.decrypt(encryptedCheck, mk).toString(CryptoJS.enc.Utf8); if (JSON.parse(decrypted) !== "VALID_ADMIN_KEY") { throw new Error("Invalid key content"); } alert("‚úÖ M·∫≠t kh·∫©u h·ª£p l·ªá. ƒêang chu·∫©n b·ªã d·ªØ li·ªáu..."); const duLieuJSON = JSON.stringify(bangDiem, null, 2); const duLieuMaHoa = CryptoJS.AES.encrypt(duLieuJSON, mk).toString(); navigator.clipboard.writeText(duLieuMaHoa).then(() => { alert("D·ªØ li·ªáu m·ªõi ƒë√£ ƒë∆∞·ª£c m√£ h√≥a v√† sao ch√©p v√†o clipboard.\n\nüëâ B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang ch·ªânh s·ª≠a. H√£y d√°n (Ctrl+V) ƒë·ªÉ thay th·∫ø n·ªôi dung c≈© v√† 'Commit changes'."); const githubEditUrl = `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/edit/${GITHUB_BRANCH}/data.enc`; window.open(githubEditUrl, '_blank'); }).catch(err => { console.error('L·ªói sao ch√©p:', err); alert('‚ùå Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p.'); }); } catch (e) { console.error("L·ªói x√°c th·ª±c:", e); alert("‚ùå M·∫≠t kh·∫©u sai!"); } }) .catch(err => { console.error("L·ªói khi t·∫£i keycheck.enc:", err); alert("‚ùå ƒê√£ x·∫£y ra l·ªói khi x√°c th·ª±c."); }); }); document.getElementById("btn-thoat").addEventListener("click", function(e) { e.preventDefault(); if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng tab n√†y?")) { window.close(); } }); document.getElementById('file-upload').addEventListener('change', function handleFileSelect(event) { const file = event.target.files[0]; if (!file) return; const feedbackEl = document.getElementById('upload-feedback'); feedbackEl.textContent = 'ƒêang x·ª≠ l√Ω file...'; feedbackEl.style.color = '#004AAD'; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(worksheet); if (jsonData.length === 0) throw new Error("File Excel tr·ªëng."); const requiredCols = ['MaMonHoc', 'TenMonHoc', 'SoTinChi', 'DiemHe10']; const header = Object.keys(jsonData[0]); if (!requiredCols.every(col => header.includes(col))) { throw new Error(`File Excel thi·∫øu c·ªôt b·∫Øt bu·ªôc. C·∫ßn c√≥: MaMonHoc, TenMonHoc, SoTinChi, DiemHe10.`); } const duLieuMoi = jsonData.map(row => { const maMonHoc = String(row.MaMonHoc || '').trim().toUpperCase(); const tenMonHoc = String(row.TenMonHoc || '').trim(); const soTinChi = parseFloat(row.SoTinChi); const diemHe10 = parseFloat(row.DiemHe10); if (!maMonHoc || !tenMonHoc || isNaN(soTinChi) || isNaN(diemHe10) || soTinChi < 1 || soTinChi > 4 || diemHe10 < 0 || diemHe10 > 10) return null; return { maMonHoc, tenMonHoc, soTinChi, diemHe10 }; }).filter(item => item !== null); if (duLieuMoi.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file Excel."); if (bangDiem.length > 0 && !confirm("B·∫°n mu·ªën THAY TH·∫æ d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu t·ª´ file? (Nh·∫•n 'Cancel' ƒë·ªÉ N·ªêI TH√äM v√†o cu·ªëi danh s√°ch)")) { duLieuMoi.forEach(monMoi => { if (!bangDiem.some(monCu => monCu.maMonHoc === monMoi.maMonHoc)) { bangDiem.push(monMoi); } }); } else { bangDiem = duLieuMoi; } capNhatBang(); tinhDiemTongKet(); feedbackEl.textContent = `T·∫£i l√™n v√† x·ª≠ l√Ω th√†nh c√¥ng ${duLieuMoi.length} m√¥n h·ªçc!`; feedbackEl.style.color = '#28a745'; } catch (err) { feedbackEl.textContent = 'L·ªói: ' + err.message; feedbackEl.style.color = 'red'; } finally { event.target.value = ''; } }; reader.onerror = () => { feedbackEl.textContent = 'L·ªói khi ƒë·ªçc file.'; feedbackEl.style.color = 'red'; }; reader.readAsArrayBuffer(file); }); document.getElementById('json-upload').addEventListener('change', function handleJsonFile(event) { const file = event.target.files[0]; if (!file) return; const feedbackEl = document.getElementById('json-upload-feedback'); feedbackEl.textContent = 'ƒêang x·ª≠ l√Ω file...'; feedbackEl.style.color = '#004AAD'; const reader = new FileReader(); reader.onload = function(e) { try { const jsonData = JSON.parse(e.target.result); if (!Array.isArray(jsonData) || jsonData.length === 0) throw new Error("File JSON kh√¥ng h·ª£p l·ªá ho·∫∑c tr·ªëng."); const requiredKeys = ['maMonHoc', 'tenMonHoc', 'soTinChi', 'diemHe10']; const duLieuMoi = jsonData.map(row => { if (!requiredKeys.every(k => row.hasOwnProperty(k)) || typeof row.maMonHoc !== 'string' || typeof row.tenMonHoc !== 'string' || isNaN(parseFloat(row.soTinChi)) || isNaN(parseFloat(row.diemHe10))) { return null; } const soTinChi = parseFloat(row.soTinChi); if (soTinChi < 1 || soTinChi > 4) return null; return { maMonHoc: row.maMonHoc.trim().toUpperCase(), tenMonHoc: row.tenMonHoc.trim(), soTinChi: soTinChi, diemHe10: parseFloat(row.diemHe10) }; }).filter(item => item !== null); if (duLieuMoi.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file JSON (ki·ªÉm tra c√°c key v√† gi√° tr·ªã)."); if (bangDiem.length > 0 && !confirm("B·∫°n mu·ªën THAY TH·∫æ d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu t·ª´ file? (Nh·∫•n 'Cancel' ƒë·ªÉ N·ªêI TH√äM v√†o cu·ªëi danh s√°ch)")) { duLieuMoi.forEach(monMoi => { if (!bangDiem.some(monCu => monCu.maMonHoc === monMoi.maMonHoc)) { bangDiem.push(monMoi); } }); } else { bangDiem = duLieuMoi; } capNhatBang(); tinhDiemTongKet(); feedbackEl.textContent = `T·∫£i l√™n v√† x·ª≠ l√Ω th√†nh c√¥ng ${duLieuMoi.length} m√¥n h·ªçc!`; feedbackEl.style.color = '#28a745'; } catch (err) { feedbackEl.textContent = 'L·ªói: ' + err.message; feedbackEl.style.color = 'red'; } finally { event.target.value = ''; } }; reader.onerror = () => { feedbackEl.textContent = 'L·ªói khi ƒë·ªçc file.'; feedbackEl.style.color = 'red'; }; reader.readAsText(file); });
</script>
</body>
</html>
