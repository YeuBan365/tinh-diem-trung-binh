<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C√¥ng c·ª• C·∫£i thi·ªán ƒêi·ªÉm - HUTECH</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2, h3 { color: #004AAD; }
        h1, h2 { border-bottom: 2px solid #eef4fb; padding-bottom: 10px; }
        .info-panel { display: flex; justify-content: space-around; background: #eef4fb; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; flex-wrap: wrap; gap: 15px; }
        .info-item { font-size: 1.1em; }
        .info-item span { display: block; font-size: 1.5em; font-weight: bold; color: #004AAD; }
        .target-gpa { color: #28a745; }
        .gpa-diff { color: #dc3545; }
        label { font-weight: bold; margin-top: 15px; display: inline-block; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 80px; margin-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #004AAD; color: white; font-weight: bold; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .diem-hientai { color: #6c757d; }
        .diem-moi { font-weight: bold; }
        .no-data { text-align: center; padding: 20px; color: #6c757d; font-style: italic; }
        .chart-gpa-container {
            border: 1px solid #eef4fb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            background-color: #fdfdff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ C√¥ng c·ª• L·∫≠p k·∫ø ho·∫°ch & C·∫£i thi·ªán ƒêi·ªÉm</h1>
        <p>Trang n√†y gi√∫p b·∫°n m√¥ ph·ªèng vi·ªác h·ªçc l·∫°i, c·∫£i thi·ªán ƒëi·ªÉm c√°c m√¥n y·∫øu ƒë·ªÉ xem ·∫£nh h∆∞·ªüng t·ªõi GPA t·ªïng th·ªÉ. H√£y thay ƒë·ªïi ƒëi·ªÉm ·ªü c·ªôt "ƒêi·ªÉm 10 M·ªõi" ƒë·ªÉ xem k·∫øt qu·∫£.</p>

        <div class="info-panel">
            <div class="info-item">GPA Hi·ªán t·∫°i<span id="gpa-hientai">0.00</span></div>
            <div class="info-item">
                GPA M·ª•c ti√™u
                <input type="number" id="gpa-muctieu" step="0.1" min="0" max="4.0" value="2.5">
            </div>
            <div class="info-item">GPA "What-if"<span id="gpa-whatif" class="target-gpa">0.00</span></div>
            <div class="info-item">C·∫ßn C·∫£i thi·ªán<span id="gpa-diff" class="gpa-diff">0.00</span></div>
        </div>
        
        <div class="chart-gpa-container">
            <h3 style="text-align:center; margin-top: 0;">üìä Bi·ªÉu ƒë·ªì so s√°nh theo GPA y√™u c·∫ßu</h3>
            <div style="text-align:center;">
              <label for="gpa-yeu-cau"><strong>üéØ GPA y√™u c·∫ßu:</strong></label>
              <input type="number" id="gpa-yeu-cau" min="0" max="4" step="0.1" value="3.2">
            </div>
            <div style="position: relative; max-width: 300px; margin: 20px auto;">
              <canvas id="chart-gpa-yeu-cau"></canvas>
            </div>
            <!-- Container cho danh s√°ch m√¥n ch∆∞a ƒë·∫°t (·∫©n m·∫∑c ƒë·ªãnh) -->
            <div id="danh-sach-chua-dat-container" style="display: none; margin-top: 20px;">
                <h3 style="text-align:center;">Danh s√°ch m√¥n ch∆∞a ƒë·∫°t y√™u c·∫ßu</h3>
                <table>
                    <thead>
                        <tr>
                            <th>M√£ M√¥n</th>
                            <th>T√™n M√¥n</th>
                            <th>S·ªë TC</th>
                            <th>ƒêi·ªÉm H·ªá 4</th>
                        </tr>
                    </thead>
                    <tbody id="body-mon-chua-dat"></tbody>
                </table>
            </div>
        </div>

        <h2>Danh s√°ch M√¥n c√≥ th·ªÉ C·∫£i thi·ªán</h2>
        <p>Ch·ªâ c√°c m√¥n "Kh√¥ng ƒê·∫°t" ho·∫∑c c√≥ ƒëi·ªÉm D/D+ (d∆∞·ªõi 5.5) ƒë∆∞·ª£c li·ªát k√™ ·ªü ƒë√¢y.</p>
        <table>
            <thead>
                <tr>
                    <th>M√£ M√¥n</th>
                    <th>T√™n M√¥n</th>
                    <th>S·ªë TC</th>
                    <th>ƒêi·ªÉm 10 Hi·ªán t·∫°i</th>
                    <th>ƒêi·ªÉm 10 M·ªõi (M√¥ ph·ªèng)</th>
                </tr>
            </thead>
            <tbody id="mon-cai-thien-body"></tbody>
        </table>
    </div>

    <script>
        let bangDiemGoc = [];
        let bangDiemMoPhong = [];
        let bieuDoTuyChinh = null;

        const tinhDiemHe4 = d => (d >= 8.5) ? 4.0 : (d >= 7.8) ? 3.5 : (d >= 7.0) ? 3.0 : (d >= 6.3) ? 2.5 : (d >= 5.5) ? 2.0 : (d >= 4.8) ? 1.5 : (d >= 4.0) ? 1.0 : 0.0;
        
        function calculateGPA(danhSachMon) {
            let tongDiemTichLuy = 0;
            let tongTin = 0;
            const monDat = danhSachMon.filter(m => m.diemHe10 >= 4.0);
            
            monDat.forEach(m => {
                tongDiemTichLuy += tinhDiemHe4(m.diemHe10) * m.soTinChi;
                tongTin += m.soTinChi;
            });
            return (tongTin > 0) ? (tongDiemTichLuy / tongTin) : 0;
        }

        function capNhatGiaoDien() {
            const gpaHienTai = calculateGPA(bangDiemGoc);
            const gpaMoi = calculateGPA(bangDiemMoPhong);
            const gpaMucTieu = parseFloat(document.getElementById('gpa-muctieu').value) || 0;

            document.getElementById('gpa-hientai').textContent = gpaHienTai.toFixed(2);
            document.getElementById('gpa-whatif').textContent = gpaMoi.toFixed(2);
            
            const diff = gpaMucTieu - gpaMoi;
            const diffEl = document.getElementById('gpa-diff');
            diffEl.textContent = diff > 0 ? `+${diff.toFixed(2)}` : 'ƒê·∫°t!';
            diffEl.style.color = diff > 0 ? '#dc3545' : '#28a745';
        }

        // ƒê√£ s·ª≠a: H√†m n√†y ch·ªâ c√≥ nhi·ªám v·ª• ƒëi·ªÅn d·ªØ li·ªáu v√† hi·ªÉn th·ªã danh s√°ch
        function hienThiDanhSachChuaDat() {
            const container = document.getElementById('danh-sach-chua-dat-container');
            const tbody = document.getElementById('body-mon-chua-dat');
            const gpaYeuCau = parseFloat(document.getElementById("gpa-yeu-cau").value);

            const chuaDat = bangDiemGoc
                .filter(m => tinhDiemHe4(m.diemHe10) < gpaYeuCau)
                .sort((a, b) => tinhDiemHe4(a.diemHe10) - tinhDiemHe4(b.diemHe10));

            tbody.innerHTML = ''; 

            if (chuaDat.length > 0) {
                chuaDat.forEach(mon => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${mon.maMonHoc}</td>
                        <td>${mon.tenMonHoc}</td>
                        <td>${mon.soTinChi}</td>
                        <td style="font-weight: bold; color: #dc3545;">${tinhDiemHe4(mon.diemHe10).toFixed(1)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="no-data">Ch√∫c m·ª´ng! T·∫•t c·∫£ c√°c m√¥n ƒë·ªÅu ƒë·∫°t y√™u c·∫ßu.</td></tr>`;
            }
            container.style.display = 'block';
        }

        function veBieuDoTheoGPAYeuCau() {
            const gpaYeuCau = parseFloat(document.getElementById("gpa-yeu-cau").value);
            if (isNaN(gpaYeuCau)) return;
            
            document.getElementById('danh-sach-chua-dat-container').style.display = 'none';

            const dat = bangDiemGoc.filter(m => tinhDiemHe4(m.diemHe10) >= gpaYeuCau);
            const chuaDat = bangDiemGoc.filter(m => tinhDiemHe4(m.diemHe10) < gpaYeuCau);

            const soTCdat = dat.reduce((tong, m) => tong + m.soTinChi, 0);
            const soTCchuaDat = chuaDat.reduce((tong, m) => tong + m.soTinChi, 0);

            const ctx = document.getElementById("chart-gpa-yeu-cau").getContext("2d");
            if (bieuDoTuyChinh) bieuDoTuyChinh.destroy();

            bieuDoTuyChinh = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [`‚úÖ ƒê·∫°t y√™u c·∫ßu (‚â• ${gpaYeuCau.toFixed(1)})`, `‚ùå Ch∆∞a ƒë·∫°t (< ${gpaYeuCau.toFixed(1)})`],
                    datasets: [{
                        data: [soTCdat, soTCchuaDat],
                        backgroundColor: ['#4caf50', '#ff9800'],
                        borderColor: '#fff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 14 } } },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw} TC` } }
                    },
                    cutout: '60%',
                    // ƒê√£ s·ª≠a: Logic onClick ƒë∆∞·ª£c t·∫≠p trung t·∫°i ƒë√¢y
                    onClick: (event, elements) => {
                        const container = document.getElementById('danh-sach-chua-dat-container');
                        if (elements.length > 0) {
                            const clickedIndex = elements[0].index;
                            // N·∫øu click v√†o ph·∫ßn "Ch∆∞a ƒë·∫°t" (index = 1)
                            if (clickedIndex === 1) {
                                // N·∫øu ƒëang hi·ªÉn th·ªã th√¨ ·∫©n ƒëi, n·∫øu ƒëang ·∫©n th√¨ hi·ªán ra
                                if (container.style.display === 'block') {
                                    container.style.display = 'none';
                                } else {
                                    hienThiDanhSachChuaDat();
                                }
                            } else {
                                // N·∫øu click v√†o b·∫•t k·ª≥ ph·∫ßn n√†o kh√°c, ·∫©n danh s√°ch ƒëi
                                container.style.display = 'none';
                            }
                        }
                    }
                }
            });
        }

        function renderBangCaiThien() {
            const tbody = document.getElementById('mon-cai-thien-body');
            tbody.innerHTML = '';
            const monCanCaiThien = bangDiemGoc
                .filter(m => m.diemHe10 < 5.5)
                .sort((a, b) => a.diemHe10 - b.diemHe10); 

            if (monCanCaiThien.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="no-data">Ch√∫c m·ª´ng! B·∫°n kh√¥ng c√≥ m√¥n n√†o c·∫ßn c·∫£i thi·ªán.</td></tr>`;
                return;
            }
            monCanCaiThien.forEach(mon => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mon.maMonHoc}</td>
                    <td>${mon.tenMonHoc}</td>
                    <td>${mon.soTinChi}</td>
                    <td class="diem-hientai">${mon.diemHe10.toFixed(1)}</td>
                    <td><input type="number" class="diem-moi" data-ma-mon="${mon.maMonHoc}" value="${mon.diemHe10.toFixed(1)}" min="0" max="10" step="0.1"></td>
                `;
                tbody.appendChild(row);
            });
            document.querySelectorAll('.diem-moi').forEach(input => {
                input.addEventListener('input', (e) => {
                    const maMon = e.target.dataset.maMon;
                    let diemMoi = parseFloat(e.target.value);
                    
                    if (isNaN(diemMoi) || diemMoi < 0) diemMoi = 0;
                    if (diemMoi > 10) diemMoi = 10;

                    const monIndex = bangDiemMoPhong.findIndex(m => m.maMonHoc === maMon);
                    if (monIndex !== -1) {
                        bangDiemMoPhong[monIndex].diemHe10 = diemMoi;
                    }
                    capNhatGiaoDien();
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const dataFromStorage = localStorage.getItem('bangDiemData');
            const chartContainer = document.querySelector('.chart-gpa-container');

            if (dataFromStorage) {
                bangDiemGoc = JSON.parse(dataFromStorage);
                bangDiemMoPhong = JSON.parse(JSON.stringify(bangDiemGoc));
                chartContainer.style.display = 'block';
                renderBangCaiThien();
                capNhatGiaoDien();
                veBieuDoTheoGPAYeuCau();
            } else {
                chartContainer.style.display = 'none';
                document.getElementById('mon-cai-thien-body').innerHTML = `<tr><td colspan="5" class="no-data">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒëi·ªÉm. Vui l√≤ng quay l·∫°i trang ch√≠nh v√† th√™m ƒëi·ªÉm tr∆∞·ªõc.</td></tr>`;
            }

            document.getElementById('gpa-muctieu').addEventListener('input', capNhatGiaoDien);
            document.getElementById("gpa-yeu-cau").addEventListener('input', veBieuDoTheoGPAYeuCau);
        });
    </script>
</body>
</html>
